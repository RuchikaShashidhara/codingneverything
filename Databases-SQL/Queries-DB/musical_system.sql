/* Define   */

DROP DATABASE IF EXISTS MUSICALSYSTEM;
CREATE DATABASE MUSICALSYSTEM;


USE MUSICALSYSTEM; 


DROP TABLE IF EXISTS MUSIC_PIECE;
CREATE TABLE MUSIC_PIECE 
(
	NO_MUSIC_PIECE SMALLINT NOT NULL,
	TITLE_MUSIC_PIECE VARCHAR(40),

	PRIMARY KEY (NO_MUSIC_PIECE)
);


DROP TABLE IF EXISTS COMPACT_DISC;
CREATE TABLE COMPACT_DISC 
(
	ID_DISC CHAR(3) NOT NULL,
	TITLE_DISC VARCHAR(20),
	PROD_YEAR SMALLINT,

	PRIMARY KEY (ID_DISC),
	
);
CREATE UNIQUE INDEX IDX_ID_DISC ON COMPACT_DISC (ID_DISC ASC);


DROP TABLE IF EXISTS RECORDED_DISCS;
CREATE TABLE RECORDED_DISCS
(
	ID_DISC CHAR(3) NOT NULL,
	NO_MUSIC_PIECE SMALLINT NOT NULL,
	NO_TRACK SMALLINT NOT NULL,

	PRIMARY KEY (ID_DISC, NO_MUSIC_PIECE, NO_TRACK),

	CONSTRAINT RECORDED_DISCS_ID_DISC
	FOREIGN KEY (ID_DISC)
	REFERENCES COMPACT_DISC (ID_DISC),

	CONSTRAINT RECORDED_DISCS_NO_MUSIC_PIECE
	FOREIGN KEY (NO_MUSIC_PIECE)
	REFERENCES MUSIC_PIECE (NO_MUSIC_PIECE)
);
CREATE INDEX IDX_NO_MUSIC_PIECE ON RECORDED_DISCS (NO_MUSIC_PIECE ASC);


DROP TABLE IF EXISTS PEOPLE;
CREATE TABLE PEOPLE
(
	ID_PERSON CHAR(6) NOT NULL,
	NAME VARCHAR(30),
	NATIONALITY VARCHAR(10),

	PRIMARY KEY (ID_PERSON)
);


DROP TABLE IF EXISTS AUTHOR;
CREATE TABLE AUTHOR
(
	TYPE_AUTHORSHIP CHAR(6) NOT NULL,
	NAME_AUTHORSHIP VARCHAR(10),

	PRIMARY KEY (TYPE_AUTHORSHIP)
);


DROP TABLE IF EXISTS AUTHORS_MUSIC_PIECE;
CREATE TABLE AUTHORS_MUSIC_PIECE
(
	NO_MUSIC_PIECE SMALLINT NOT NULL,
	ID_PERSON CHAR(6) NOT NULL,
	TYPE_AUTHORSHIP CHAR(6) NOT NULL,

	PRIMARY KEY (NO_MUSIC_PIECE, ID_PERSON, TYPE_AUTHORSHIP),

	CONSTRAINT AUTHORS_MUSIC_PIECE_NO_MUSIC_PIECE
	FOREIGN KEY (NO_MUSIC_PIECE)
	REFERENCES MUSIC_PIECE (NO_MUSIC_PIECE)
	ON UPDATE CASCADE,

	CONSTRAINT AUTHORS_MUSIC_PIECE_ID_PERSON
	FOREIGN KEY (ID_PERSON)
	REFERENCES PEOPLE (ID_PERSON)
	ON UPDATE CASCADE,
	
	CONSTRAINT AUTHORS_MUSIC_PIECE_TYPE_AUTHORSHIP
	FOREIGN KEY (TYPE_AUTHORSHIP)
	REFERENCES AUTHOR (TYPE_AUTHORSHIP)
	ON UPDATE CASCADE
);
CREATE INDEX IDX_ID_PERSON ON AUTHORS_MUSIC_PIECE (ID_PERSON ASC);
CREATE INDEX IDX_TYPE_AUTHORSHIP ON AUTHORS_MUSIC_PIECE (TYPE_AUTHORSHIP ASC);


DROP TABLE IF EXISTS INSTRUMENTS;
CREATE TABLE INSTRUMENTS
(
	ID_INSTRUMENT CHAR(7) NOT NULL,
	NAME_OF_INSTRUMENT VARCHAR(10),

	PRIMARY KEY (ID_INSTRUMENT)
);


DROP TABLE IF EXISTS PLAYS;
CREATE TABLE PLAYS
(
	ID_PERSON CHAR(6) NOT NULL,
	NO_MUSIC_PIECE SMALLINT NOT NULL,
	ID_INSTRUMENT CHAR(7) NOT NULL,

	PRIMARY KEY (ID_PERSON, NO_MUSIC_PIECE, ID_INSTRUMENT),

	CONSTRAINT PLAYS_ID_PERSON
	FOREIGN KEY (ID_PERSON)
	REFERENCES PEOPLE (ID_PERSON)
	ON UPDATE CASCADE,

	CONSTRAINT PLAYS_NO_MUSIC_PIECE
	FOREIGN KEY (NO_MUSIC_PIECE)
	REFERENCES MUSIC_PIECE (NO_MUSIC_PIECE)
	ON UPDATE CASCADE,

	CONSTRAINT PLAYS_ID_INSTRUMENT
	FOREIGN KEY (ID_INSTRUMENT)
	REFERENCES INSTRUMENTS (ID_INSTRUMENT)
	ON UPDATE CASCADE
);
CREATE INDEX IDX_NO_MUSIC_PIECE ON PLAYS (NO_MUSIC_PIECE ASC);
CREATE INDEX IDX_ID_INSTRUMENT ON PLAYS (ID_INSTRUMENT ASC);

/* Populate */

use MusicalSystem;

insert into COMPACT_DISC values('X01','BOY',1980);
insert into COMPACT_DISC values('X02','TARZAN',2006);

insert into MUSIC_PIECE values(01,'I will follow');
insert into MUSIC_PIECE values(02,'Twilight');
insert into MUSIC_PIECE values(03,'An cat Bubh');
insert into MUSIC_PIECE values(04,'into the heart');
insert into MUSIC_PIECE values(05,'Out of control');
insert into MUSIC_PIECE values(06,'Youll be in my heart');
insert into MUSIC_PIECE values(07,'Who better than me');

insert into PEOPLE values('PER_01','LAWRENCE MULLEN','BRITISH');
insert into PEOPLE values('PER_02','DAVID HOWELL','BRITISH');
insert into PEOPLE values('PER_03','ADAM CLAYTON','BRITISH');
insert into PEOPLE values('PER_04','PAUL DAVIDSON','BRITISH');
insert into PEOPLE values('PER_05','PHIL COLLINS','AMERICAN');

insert into AUTHOR values('AUT_01', 'COMPOSER');
insert into AUTHOR values('AUT_02', 'WRITER');
insert into AUTHOR values('AUT_03', 'ARRENGER');

insert into INSTRUMENTS values('INST_01','GUITAR');
insert into INSTRUMENTS values('INST_02','BASS');
insert into INSTRUMENTS values('INST_03','KEYBOARD');

insert into RECORDED_DISCS values('X01',01,01);
insert into RECORDED_DISCS values('X01',02,02);
insert into RECORDED_DISCS values('X01',03,03);
insert into RECORDED_DISCS values('X01',04,04);
insert into RECORDED_DISCS values('X01',05,05);
insert into RECORDED_DISCS values('X02',01,06);
insert into RECORDED_DISCS values('X02',02,07);

insert into PLAYS values('PER_02',01,'INST_01');
insert into PLAYS values('PER_02',02,'INST_02');
insert into PLAYS values('PER_03',03,'INST_03');
insert into PLAYS values('PER_04',04,'INST_01');
insert into PLAYS values('PER_05',05,'INST_01');

insert into AUTHORS_MUSIC_PIECE values (01,'PER_01','AUT_01');
insert into AUTHORS_MUSIC_PIECE values (02,'PER_01','AUT_01');
insert into AUTHORS_MUSIC_PIECE values (03,'PER_01','AUT_02');
insert into AUTHORS_MUSIC_PIECE values (04,'PER_03','AUT_03');
insert into AUTHORS_MUSIC_PIECE values (05,'PER_02','AUT_02');

/* Queries  */

USE MUSICALSYSTEM;


/*
i. Given the key of the disc X01 obtain its title, year of production and the
musical pieces it contains.
*/
-----
SELECT	CD.TITLE_DISC, CD.PROD_YEAR, MP.TITLE_MUSIC_PIECE, RD.NO_TRACK
FROM	COMPACT_DISC CD, RECORDED_DISCS RD, MUSIC_PIECE MP
WHERE	CD.ID_DISC = 'X01' AND 
		CD.ID_DISC = RD.ID_DISC AND 
		RD.NO_MUSIC_PIECE = MP.NO_MUSIC_PIECE
ORDER BY RD.NO_TRACK;
-----
SELECT	CD.TITLE_DISC, CD.PROD_YEAR, MP.TITLE_MUSIC_PIECE, RD.NO_TRACK
FROM	COMPACT_DISC CD  
		INNER JOIN RECORDED_DISCS RD ON CD.ID_DISC = RD.ID_DISC
		INNER JOIN MUSIC_PIECE MP ON RD.NO_MUSIC_PIECE = MP.NO_MUSIC_PIECE
WHERE	CD.ID_DISC = 'X01'		
ORDER BY RD.NO_TRACK;
-----


/* 
ii. Given the name of a piece of music, it is required to know 
the name of the instrumentalists and the name of the instrument that they play, 
as well as the author's name and type of authorship for all the people who 
participated in the piece of music. The output should be like: 
PIECE_OF_MUSIC, NAME_OF_PERSON, INSTRUMENT or AUTHORSHIP 
*/
-----
DECLARE @NAME_OF_MUSIC_PIECE AS VARCHAR(40)
SET @NAME_OF_MUSIC_PIECE = 'I will follow'

SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		P.NAME AS NAME_OF_PERSON, 
		I.NAME_OF_INSTRUMENT AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP, PLAYS PL, PEOPLE P, INSTRUMENTS I
WHERE	TITLE_MUSIC_PIECE = @NAME_OF_MUSIC_PIECE AND
		MP.NO_MUSIC_PIECE = PL.NO_MUSIC_PIECE AND
		PL.ID_PERSON = P.ID_PERSON AND
		PL.ID_INSTRUMENT = I.ID_INSTRUMENT
UNION
SELECT  MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		P.NAME AS NAME_OF_PERSON, 
		A.NAME_AUTHORSHIP AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP, AUTHORS_MUSIC_PIECE AMP, PEOPLE P, AUTHOR A
WHERE	TITLE_MUSIC_PIECE = @NAME_OF_MUSIC_PIECE AND
		MP.NO_MUSIC_PIECE = AMP.NO_MUSIC_PIECE AND
		AMP.ID_PERSON = P.ID_PERSON AND
		AMP.TYPE_AUTHORSHIP = A.TYPE_AUTHORSHIP
ORDER BY 1,2;
-----
DECLARE @NAME_OF_MUSIC_PIECE1 AS VARCHAR(40)
SET @NAME_OF_MUSIC_PIECE1 = 'I will follow'

SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		P.NAME AS NAME_OF_PERSON, 
		I.NAME_OF_INSTRUMENT AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP
		INNER JOIN PLAYS PL ON MP.NO_MUSIC_PIECE = PL.NO_MUSIC_PIECE
		INNER JOIN PEOPLE P ON PL.ID_PERSON = P.ID_PERSON
		INNER JOIN INSTRUMENTS I ON PL.ID_INSTRUMENT = I.ID_INSTRUMENT
WHERE	TITLE_MUSIC_PIECE = @NAME_OF_MUSIC_PIECE1		
UNION
SELECT  MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		P.NAME AS NAME_OF_PERSON, 
		A.NAME_AUTHORSHIP AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP
		INNER JOIN AUTHORS_MUSIC_PIECE AMP ON MP.NO_MUSIC_PIECE = AMP.NO_MUSIC_PIECE
		INNER JOIN PEOPLE P ON AMP.ID_PERSON = P.ID_PERSON
		INNER JOIN AUTHOR A ON AMP.TYPE_AUTHORSHIP = A.TYPE_AUTHORSHIP
WHERE	TITLE_MUSIC_PIECE = @NAME_OF_MUSIC_PIECE1
ORDER BY 1,2;
-----


/*
iii. Given an instrument such as guitar, get all the instrumentalists who play it.
*/
-----
SELECT	P.NAME, I.NAME_OF_INSTRUMENT
FROM	INSTRUMENTS I, PLAYS PL, PEOPLE P
WHERE	I.NAME_OF_INSTRUMENT = 'GUITAR' AND
		I.ID_INSTRUMENT = PL.ID_INSTRUMENT AND
		PL.ID_PERSON = P.ID_PERSON
ORDER BY P.NAME;
-----
SELECT	P.NAME, I.NAME_OF_INSTRUMENT
FROM	INSTRUMENTS I
		INNER JOIN PLAYS PL ON I.ID_INSTRUMENT = PL.ID_INSTRUMENT
		INNER JOIN PEOPLE P ON PL.ID_PERSON = P.ID_PERSON
WHERE	I.NAME_OF_INSTRUMENT = 'GUITAR'
ORDER BY P.NAME;
-----
SELECT P.NAME
FROM PEOPLE P
WHERE P.ID_PERSON IN (
	SELECT PL.ID_PERSON
	FROM PLAYS PL
	WHERE PL.ID_INSTRUMENT IN (
		SELECT I.ID_INSTRUMENT
		FROM INSTRUMENTS I
		WHERE I.NAME_OF_INSTRUMENT = 'GUITAR'
	)
)
ORDER BY P.NAME;
-----
		

/* 
iv. Given a piece of music, it is necessary to know the title, year of production
of the discs that contain it and in which track, as well as the names of authors,
their type of authorship, their nationality and the names of instrumentalists with
the instruments they play in said musical piece. The output should be like:
PIECE_OF_MUSIC, YEAR_PRODUCTION, TRACK_NUMBER,
NAME_OF_PERSON, NATIONALITY, INSTRUMENT or AUTHORSHIP 
*/
-----
SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		CD.PROD_YEAR AS YEAR_PRODUCTION,
		RD.NO_TRACK AS TRACK_NUMBER,
		P.NAME AS NAME_OF_PERSON, P.NATIONALITY,
		A.NAME_AUTHORSHIP AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP, RECORDED_DISCS RD, COMPACT_DISC CD,
		AUTHORS_MUSIC_PIECE AMP, AUTHOR A, PEOPLE P
WHERE	MP.NO_MUSIC_PIECE = RD.NO_MUSIC_PIECE AND
		RD.ID_DISC = CD.ID_DISC AND
		MP.NO_MUSIC_PIECE = AMP.NO_MUSIC_PIECE AND
		AMP.ID_PERSON = P.ID_PERSON AND
		AMP.TYPE_AUTHORSHIP = A.TYPE_AUTHORSHIP
UNION
SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		CD.PROD_YEAR AS YEAR_PRODUCTION,
		RD.NO_TRACK AS TRACK_NUMBER,
		P.NAME AS NAME_OF_PERSON, P.NATIONALITY,
		I.NAME_OF_INSTRUMENT AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP, RECORDED_DISCS RD, COMPACT_DISC CD,
		PLAYS PL, INSTRUMENTS I, PEOPLE P
WHERE	MP.NO_MUSIC_PIECE = RD.NO_MUSIC_PIECE AND
		RD.ID_DISC = CD.ID_DISC AND
		MP.NO_MUSIC_PIECE = PL.NO_MUSIC_PIECE AND
		PL.ID_PERSON = P.ID_PERSON AND
		PL.ID_INSTRUMENT = I.ID_INSTRUMENT
ORDER BY PIECE_OF_MUSIC, YEAR_PRODUCTION, TRACK_NUMBER;
-----
SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		CD.PROD_YEAR AS YEAR_PRODUCTION,
		RD.NO_TRACK AS TRACK_NUMBER,
		P.NAME AS NAME_OF_PERSON, P.NATIONALITY,
		A.NAME_AUTHORSHIP AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP
		INNER JOIN RECORDED_DISCS RD ON MP.NO_MUSIC_PIECE = RD.NO_MUSIC_PIECE
		INNER JOIN COMPACT_DISC CD ON RD.ID_DISC = CD.ID_DISC
		INNER JOIN AUTHORS_MUSIC_PIECE AMP ON MP.NO_MUSIC_PIECE = AMP.NO_MUSIC_PIECE
		INNER JOIN AUTHOR A ON AMP.TYPE_AUTHORSHIP = A.TYPE_AUTHORSHIP
		INNER JOIN PEOPLE P ON AMP.ID_PERSON = P.ID_PERSON
UNION
SELECT	MP.TITLE_MUSIC_PIECE AS PIECE_OF_MUSIC,
		CD.PROD_YEAR AS YEAR_PRODUCTION,
		RD.NO_TRACK AS TRACK_NUMBER,
		P.NAME AS NAME_OF_PERSON, P.NATIONALITY,
		I.NAME_OF_INSTRUMENT AS 'INSTRUMENT/AUTHORSHIP'
FROM	MUSIC_PIECE MP
		INNER JOIN RECORDED_DISCS RD ON MP.NO_MUSIC_PIECE = RD.NO_MUSIC_PIECE
		INNER JOIN COMPACT_DISC CD ON RD.ID_DISC = CD.ID_DISC
		INNER JOIN PLAYS PL ON MP.NO_MUSIC_PIECE = PL.NO_MUSIC_PIECE
		INNER JOIN INSTRUMENTS I ON PL.ID_INSTRUMENT = I.ID_INSTRUMENT
		INNER JOIN PEOPLE P ON PL.ID_PERSON = P.ID_PERSON
ORDER BY PIECE_OF_MUSIC, YEAR_PRODUCTION, TRACK_NUMBER;
-----
